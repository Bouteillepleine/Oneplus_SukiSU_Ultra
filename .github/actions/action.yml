name: 'Build OnePlus Kernel with SukiSU'

inputs:
  op_config_json:
    description: 'Device configuration JSON'
    required: true
  ksu_meta:
    description: 'KSU metadata path'
    required: false
    default: 'susfs-main/âš¡Ultraâš¡/'
  hook:
    description: 'Hook type (kprobe/manual/tracepoint)'
    required: false
    default: 'manual'
  lsm:
    description: 'Enable BBG LSM'
    required: false
    default: 'false'
  enable_zram:
    description: 'Enable ZRAM module'
    required: false
    default: 'false'
  sched:
    description: 'Enable Fengchi scheduler'
    required: false
    default: 'false'
  optimize_level:
    description: 'Optimization level (O2/O3)'
    required: false
    default: 'O2'
  clean:
    description: 'Clean build (disable ccache)'
    required: false
    default: 'false'
  github_token:
    description: 'GitHub token for API access'
    required: true

outputs:
  kernel_version:
    description: 'Built kernel version'
    value: ${{ steps.save_metadata.outputs.kernel_version }}
  sukisu_version:
    description: 'SukiSU version'
    value: ${{ steps.save_metadata.outputs.sukisu_version }}
  susfs_version:
    description: 'SUSFS version'
    value: ${{ steps.save_metadata.outputs.susfs_version }}
  zip_name:
    description: 'Generated ZIP filename'
    value: ${{ steps.create_zip.outputs.zip_name }}
  zip_size:
    description: 'ZIP file size in bytes'
    value: ${{ steps.create_zip.outputs.zip_size }}
  zip_sha256:
    description: 'ZIP SHA256 checksum'
    value: ${{ steps.create_zip.outputs.zip_sha256 }}
  build_time:
    description: 'Build duration in seconds'
    value: ${{ steps.collect_stats.outputs.build_time }}
  ccache_hit_rate:
    description: 'ccache hit rate percentage'
    value: ${{ steps.ccache_stats.outputs.hit_rate }}
  ccache_direct_rate:
    description: 'ccache direct hit rate percentage'
    value: ${{ steps.ccache_stats.outputs.direct_rate }}
  ccache_hits:
    description: 'Total ccache hits'
    value: ${{ steps.ccache_stats.outputs.ccache_hits }}
  ccache_misses:
    description: 'Total ccache misses'
    value: ${{ steps.ccache_stats.outputs.ccache_misses }}
  warnings_count:
    description: 'Compiler warnings count'
    value: ${{ steps.collect_stats.outputs.warnings_count }}
  image_sha256:
    description: 'Kernel Image SHA256'
    value: ${{ steps.collect_stats.outputs.image_sha256 }}

runs:
  using: 'composite'
  steps:
    - name: ðŸ“‹ Parse device configuration
      id: parse_config
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Parse configuration"
        
        CONFIG='${{ inputs.op_config_json }}'
        
        OP_MODEL=$(jq -r '.model' <<<"$CONFIG")
        OP_SOC=$(jq -r '.soc' <<<"$CONFIG")
        OP_MANIFEST=$(jq -r '.manifest' <<<"$CONFIG")
        OP_BRANCH=$(jq -r '.branch' <<<"$CONFIG")
        ANDROID_VER=$(jq -r '.android_version' <<<"$CONFIG")
        KERNEL_VER=$(jq -r '.kernel_version' <<<"$CONFIG")
        
        for v in OP_MODEL OP_SOC OP_MANIFEST OP_BRANCH ANDROID_VER KERNEL_VER; do
          val="${!v}"
          [ -z "$val" ] || [ "$val" = "null" ] && { echo "::error::Missing $v"; exit 1; }
          echo "$v=$val" >> "$GITHUB_ENV"
        done
        
        echo "âœ… Configuration loaded:"
        echo "   Model: $OP_MODEL"
        echo "   SoC: $OP_SOC"
        echo "   Android: $ANDROID_VER"
        echo "   Kernel: $KERNEL_VER"
        echo "   Branch: $OP_BRANCH"
        echo "::endgroup::"

    - name: ðŸ”§ Install dependencies
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Install build dependencies"
        
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          bc bison build-essential ccache curl flex \
          g++-multilib gcc-multilib git git-lfs gnupg gperf \
          imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev \
          libelf-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev \
          libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev python-is-python3 \
          libtinfo5 libncurses5 jq
        
        echo "âœ… Dependencies installed"
        echo "::endgroup::"

    - name: ðŸ“¥ Setup repo tool
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Setup repo"
        
        mkdir -p ~/.bin
        curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo -o ~/.bin/repo
        chmod a+rx ~/.bin/repo
        echo "$HOME/.bin" >> "$GITHUB_PATH"
        
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global color.ui false
        
        echo "âœ… repo tool configured"
        echo "::endgroup::"

    - name: ðŸ” Detect Clang version
      id: detect_clang
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Detect Clang version"
        
        CONFIG="${OP_MODEL}"
        mkdir -p "$CONFIG"
        cd "$CONFIG"
        
        if [[ "$OP_MANIFEST" == http* ]]; then
          repo init -u "$OP_MANIFEST" -b "$OP_BRANCH" --depth=1 --git-lfs
        else
          repo init -u https://github.com/OnePlus-sm8650/android_kernel_manifest \
                   -b "$OP_BRANCH" -m "$OP_MANIFEST" --depth=1 --git-lfs
        fi
        
        repo sync -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync -j$(nproc --all)
        
        CLANG_PATH="kernel_platform/prebuilts/clang/host/linux-x86"
        if [ ! -d "$CLANG_PATH" ]; then
          echo "::error::Clang directory not found"
          exit 1
        fi
        
        CLANG_DIR=$(find "$CLANG_PATH" -maxdepth 1 -type d -name "clang-r*" | sort -V | tail -1)
        [ -z "$CLANG_DIR" ] && { echo "::error::No clang-r* found"; exit 1; }
        
        CLANG_VERSION=$(basename "$CLANG_DIR")
        CLANG_VERSION_SHORT="${CLANG_VERSION#clang-}"
        
        echo "CLANG_VERSION=$CLANG_VERSION" >> "$GITHUB_ENV"
        echo "CLANG_VERSION_SHORT=$CLANG_VERSION_SHORT" >> "$GITHUB_ENV"
        
        echo "âœ… Detected Clang: $CLANG_VERSION"
        echo "::endgroup::"

    - name: âš™ï¸ Set Cache Environment
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Configure ccache environment"
        
        CACHE_DIR="/mnt/ccache/${OP_MODEL}"
        sudo mkdir -p "$CACHE_DIR"
        sudo chown "$USER:$USER" "$CACHE_DIR"
        
        echo "CCACHE_DIR=$CACHE_DIR" >> "$GITHUB_ENV"
        echo "CCACHE_MAXSIZE=30G" >> "$GITHUB_ENV"
        echo "CCACHE_BASEDIR=${GITHUB_WORKSPACE}" >> "$GITHUB_ENV"
        
        echo "Cache configuration:"
        echo "  Directory: $CACHE_DIR"
        echo "  Max size: 30G"
        echo "  Base dir: ${GITHUB_WORKSPACE}"
        echo "  Android: ${ANDROID_VER:-unknown}"
        echo "  Kernel: ${KERNEL_VER:-unknown}"
        echo "  Clang: ${CLANG_VERSION_SHORT:-unknown}"
        echo "  Device: ${OP_MODEL:-unknown}"
        echo "::endgroup::"

    - name: ðŸ“¦ Restore ccache
      if: ${{ inputs.clean != 'true' }}
      uses: actions/cache/restore@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-v3-${{ runner.os }}-${{ env.ANDROID_VER }}-${{ env.KERNEL_VER }}-${{ env.CLANG_VERSION_SHORT }}-${{ env.OP_MODEL }}
        restore-keys: |
          ccache-v3-${{ runner.os }}-${{ env.ANDROID_VER }}-${{ env.KERNEL_VER }}-${{ env.CLANG_VERSION_SHORT }}-
          ccache-v3-${{ runner.os }}-${{ env.ANDROID_VER }}-${{ env.KERNEL_VER }}-
          ccache-v3-${{ runner.os }}-${{ env.ANDROID_VER }}-
          ccache-v3-${{ runner.os }}-

    - name: ðŸ”§ Configure ccache
      if: ${{ inputs.clean != 'true' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Configure ccache"
        
        export CCACHE_DIR="${CCACHE_DIR:-$HOME/.ccache}"
        export CCACHE_MAXSIZE="${CCACHE_MAXSIZE:-30G}"
        export CCACHE_BASEDIR="${CCACHE_BASEDIR:-${GITHUB_WORKSPACE}}"
        
        mkdir -p "$CCACHE_DIR"
        ccache -M "$CCACHE_MAXSIZE"
        
        ccache --set-config=compression=true
        ccache --set-config=compression_level=3
        ccache --set-config=max_size="$CCACHE_MAXSIZE"
        ccache --set-config=cache_dir="$CCACHE_DIR"
        ccache --set-config=base_dir="$CCACHE_BASEDIR"
        ccache --set-config=hash_dir=false
        ccache --set-config=sloppiness=file_macro,time_macros,include_file_mtime,include_file_ctime,file_stat_matches
        ccache --set-config=direct_mode=true
        ccache --set-config=depend_mode=true
        ccache --set-config=file_clone=true
        ccache --set-config=inode_cache=true
        ccache --set-config=readonly_direct=true
        ccache --set-config=compiler_check=content
        
        ccache -z
        ccache -p | grep -iE "(max_size|cache_dir|base_dir|compression|direct_mode|sloppiness|compiler_check)" || true
        
        echo "âœ… ccache configured"
        echo "::endgroup::"

    - name: ðŸ“¥ Download AnyKernel3
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Download AnyKernel3"
        
        if [ ! -d "AnyKernel3" ]; then
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          echo "âœ… AnyKernel3 cloned"
        else
          echo "â„¹ï¸ AnyKernel3 already exists"
        fi
        
        echo "::endgroup::"

    - name: ðŸ”¨ Apply KernelSU patches
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Apply KernelSU patches"
        
        CONFIG_DIR="$GITHUB_WORKSPACE/${OP_MODEL}"
        KERNEL_PATH="$CONFIG_DIR/kernel_platform"
        COMMON="$KERNEL_PATH/common"
        
        cd "$COMMON"
        
        if [ ! -d "KernelSU" ]; then
          curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/susfs-main/kernel/setup.sh" | bash -s "${{ inputs.ksu_meta }}"
          
          if [ ! -d "KernelSU" ]; then
            echo "::error::KernelSU setup failed"
            exit 1
          fi
          
          echo "âœ… KernelSU patches applied"
        else
          echo "â„¹ï¸ KernelSU already present"
        fi
        
        cd KernelSU
        SUKISUVER=$(git rev-list --count HEAD)
        SUKISUVER=$((SUKISUVER + 10700))
        echo "SUKISUVER=$SUKISUVER" >> "$GITHUB_ENV"
        echo "SukiSU version: $SUKISUVER"
        
        if [ -f "../include/linux/susfs.h" ]; then
          SUSVER=$(grep '#define SUSFS_VERSION' "../include/linux/susfs.h" | awk -F'"' '{print $2}')
          echo "SUSVER=$SUSVER" >> "$GITHUB_ENV"
          echo "SUSFS version: $SUSVER"
        fi
        
        echo "::endgroup::"

    - name: ðŸ”§ Configure kernel options
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Configure kernel"
        
        CONFIG_DIR="$GITHUB_WORKSPACE/${OP_MODEL}"
        COMMON="$CONFIG_DIR/kernel_platform/common"
        
        cd "$COMMON"
        
        echo "Applying KernelSU hook: ${{ inputs.hook }}"
        
        case "${{ inputs.hook }}" in
          kprobe)
            grep -q "CONFIG_KPROBES=y" "arch/arm64/configs/gki_defconfig" || \
              echo "CONFIG_KPROBES=y" >> "arch/arm64/configs/gki_defconfig"
            ;;
          manual)
            if [ -f "fs/exec.c" ] && [ -f "fs/open.c" ] && [ -f "fs/read_write.c" ] && [ -f "fs/stat.c" ]; then
              echo "Applying manual hooks..."
              
              if ! grep -q "ksu_handle_execveat_sucompat" "fs/exec.c"; then
                sed -i '/static int do_execveat_common/i\extern bool ksu_vfs_read_hook __read_mostly;\nextern int ksu_handle_execveat_sucompat(int *fd, struct filename **filename_ptr, void *argv, void *envp, int *flags);\nextern int ksu_handle_execve(int *fd, struct filename **filename_ptr, void *argv, void *envp, int *flags);' fs/exec.c
                sed -i '/static int do_execveat_common/a\\tif (unlikely(ksu_vfs_read_hook)) ksu_handle_execveat_sucompat(&fd, &filename, &argv, &envp, &flags);\n\telse ksu_handle_execve(&fd, &filename, &argv, &envp, &flags);' fs/exec.c
              fi
              
              if ! grep -q "ksu_handle_vfs_read" "fs/read_write.c"; then
                sed -i '/ssize_t vfs_read/i\extern bool ksu_vfs_read_hook __read_mostly;\nextern int ksu_handle_vfs_read(struct file **file_ptr, char __user **buf_ptr, size_t *count_ptr, loff_t **pos);' fs/read_write.c
                sed -i '/ssize_t vfs_read/a\\tif (unlikely(ksu_vfs_read_hook)) ksu_handle_vfs_read(&file, &buf, &count, &pos);' fs/read_write.c
              fi
              
              if ! grep -q "ksu_handle_faccessat" "fs/open.c"; then
                sed -i '/long do_faccessat/i\extern int ksu_handle_faccessat(int *dfd, const char __user **filename_user, int *mode, int *flags);' fs/open.c
                sed -i '/long do_faccessat/a\\tksu_handle_faccessat(&dfd, &filename, &mode, &flags);' fs/open.c
              fi
              
              if ! grep -q "ksu_handle_stat" "fs/stat.c"; then
                sed -i '/int vfs_statx(/i\extern int ksu_handle_stat(int *dfd, const char __user **filename_user, int *flags);' fs/stat.c
                sed -i '/int vfs_statx(/a\\tksu_handle_stat(&dfd, &filename, &flags);' fs/stat.c
              fi
              
              echo "âœ… Manual hooks applied"
            else
              echo "::warning::Required files not found for manual hooks"
            fi
            ;;
          tracepoint)
            echo "Using tracepoint hook (default)"
            ;;
        esac
        
        if [ "${{ inputs.lsm }}" = "true" ]; then
          echo "Enabling BBG LSM..."
          if [ -f "security/Makefile" ]; then
            grep -q "obj-\$(CONFIG_SECURITY_BBG) += bbg/" "security/Makefile" || \
              echo "obj-\$(CONFIG_SECURITY_BBG) += bbg/" >> "security/Makefile"
          fi
          grep -q "CONFIG_SECURITY_BBG=y" "arch/arm64/configs/gki_defconfig" || \
            echo "CONFIG_SECURITY_BBG=y" >> "arch/arm64/configs/gki_defconfig"
          echo "âœ… BBG LSM enabled"
        fi
        
        if [ "${{ inputs.sched }}" = "true" ]; then
          echo "Enabling Fengchi scheduler..."
          grep -q "CONFIG_SCHED_FENGCHI=y" "arch/arm64/configs/gki_defconfig" || \
            echo "CONFIG_SCHED_FENGCHI=y" >> "arch/arm64/configs/gki_defconfig"
          echo "âœ… Fengchi scheduler enabled"
        fi
        
        echo "::endgroup::"

    - name: ðŸ”¨ Build kernel
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Build kernel"
        
        CONFIG_DIR="$GITHUB_WORKSPACE/${OP_MODEL}"
        KERNEL_PATH="$CONFIG_DIR/kernel_platform"
        COMMON="$KERNEL_PATH/common"
        
        cd "$COMMON"
        
        KERNEL_FULL_VER=$(make kernelversion 2>/dev/null || echo "unknown")
        echo "KERNEL_FULL_VER=$KERNEL_FULL_VER" >> "$GITHUB_ENV"
        
        ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
        mkdir -p "$ARTIFACTS_DIR"
        echo "$KERNEL_FULL_VER" > "$ARTIFACTS_DIR/kernel_version.txt"
        
        export KBUILD_BUILD_TIMESTAMP="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        export KBUILD_BUILD_USER="github-actions"
        export KBUILD_BUILD_HOST="github"
        
        CUSTOM_LOCALVERSION="-SukiSU-v${SUKISUVER:-unknown}-SUSFS-${SUSVER:-unknown}-${OP_MODEL}"
        
        CLANG_PATH="$KERNEL_PATH/prebuilts/clang/host/linux-x86/${CLANG_VERSION}"
        GCC_PATH="$KERNEL_PATH/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin"
        GCC32_PATH="$KERNEL_PATH/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/bin"
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          CCACHE_BIN="/usr/bin/ccache"
          mkdir -p "$COMMON/ccache-bin"
          
          for tool in clang clang++ gcc g++ cc c++; do
            cat > "$COMMON/ccache-bin/$tool" << EOF
          #!/bin/bash
          exec $CCACHE_BIN ${CLANG_PATH}/bin/$tool "\$@"
          EOF
            chmod +x "$COMMON/ccache-bin/$tool"
          done
          
          export PATH="$COMMON/ccache-bin:${CLANG_PATH}/bin:${GCC_PATH}:${GCC32_PATH}:${PATH}"
        else
          export PATH="${CLANG_PATH}/bin:${GCC_PATH}:${GCC32_PATH}:${PATH}"
        fi
        
        if [ "${{ inputs.clean }}" = "true" ]; then
          echo "ðŸ§¹ Clean build mode - ccache disabled"
          export CCACHE_DISABLE=1
        else
          echo "ðŸš€ ccache-accelerated build"
        fi
        
        WORKSPACE="${{ github.workspace }}"
        MAP="-fdebug-prefix-map=${WORKSPACE}=."
        MPMAP="-fmacro-prefix-map=${WORKSPACE}=."
        FPMAP="-ffile-prefix-map=${WORKSPACE}=."
        
        export KCFLAGS="${KCFLAGS:-} $MAP $MPMAP $FPMAP -no-canonical-prefixes -fdiagnostics-color=never -Qunused-arguments -Wno-unused-command-line-argument"
        export KCPPFLAGS="${KCPPFLAGS:-} $MAP $MPMAP $FPMAP"
        
        export CC="clang"
        export CXX="clang++"
        export HOSTCC="clang"
        export HOSTCXX="clang++"
        
        export LLVM=1 LLVM_IAS=1
        export ARCH=arm64 SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-android-
        export CROSS_COMPILE_COMPAT=arm-linux-androideabi-
        export LD=ld.lld HOSTLD=ld.lld AR=llvm-ar NM=llvm-nm 
        export OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip
    
        OUT=out
        mkdir -p "$OUT"
        
        echo "============================================"
        echo "ðŸ” Compiler & ccache Verification"
        echo "============================================"
        echo "PATH: ${PATH:0:200}..."
        echo "which clang: $(which clang)"
        echo "CC: $CC"
        echo "CXX: $CXX"
        echo "CCACHE_BASEDIR: ${CCACHE_BASEDIR:-not set}"
        echo ""
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          echo "ccache wrapper test:"
          clang --version 2>&1 | head -n1 || true
          echo ""
          echo "ccache configuration:"
          ccache -p | grep -iE "(compression|direct_mode|readonly_direct|depend|sloppiness|compiler_check)" || true
          echo ""
          echo "ccache pre-build status:"
          ccache -s | head -n 20
        fi
        echo "============================================"
        
        make O="$OUT" gki_defconfig
        
        if [ -n "${CUSTOM_LOCALVERSION:-}" ]; then
          scripts/config --file "$OUT/.config" --set-str LOCALVERSION "${CUSTOM_LOCALVERSION}"
          scripts/config --file "$OUT/.config" -d LOCALVERSION_AUTO || true
          sed -i 's/scm_version="$(scm_version --short)"/scm_version=""/' scripts/setlocalversion
        fi
        
        if [ "${{ inputs.optimize_level }}" = "O3" ]; then
          scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE
          scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
          KCFLAGS_EXTRA="-O3"
        else
          scripts/config --file "$OUT/.config" -e CC_OPTIMIZE_FOR_PERFORMANCE
          scripts/config --file "$OUT/.config" -d CC_OPTIMIZE_FOR_PERFORMANCE_O3
          KCFLAGS_EXTRA="-O2"
        fi
        
        scripts/config --file "$OUT/.config" -e LTO_CLANG_THIN
        scripts/config --file "$OUT/.config" -e LTO_CLANG
        make O="$OUT" olddefconfig
        
        KCFLAGS="$KCFLAGS -Wno-error -pipe -fno-stack-protector ${KCFLAGS_EXTRA}"
        KCPPFLAGS="$KCPPFLAGS -DCONFIG_OPTIMIZE_INLINING"
        
        echo "============================================"
        echo "ðŸ”§ Build Configuration"
        echo "============================================"
        echo "Device: ${OP_MODEL}"
        echo "Kernel: ${KERNEL_FULL_VER}"
        echo "Threads: $(nproc --all)"
        echo "Optimization: ${{ inputs.optimize_level }}"
        echo "KCFLAGS: ${KCFLAGS:0:150}..."
        echo "Timestamp: $KBUILD_BUILD_TIMESTAMP"
        echo "Workspace: $WORKSPACE"
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          echo "ccache: ENABLED"
          echo "  Dir: $CCACHE_DIR"
          echo "  Base: $CCACHE_BASEDIR"
          echo "  Max size: $CCACHE_MAXSIZE"
          echo "  Compression: zstd level 3"
          echo "  Features: readonly_direct, file_clone, inode_cache, depend_mode, compiler_check=content"
        else
          echo "ccache: DISABLED"
        fi
        echo "============================================"
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          if [ ! -d "$CCACHE_DIR" ] || [ -z "$(find "$CCACHE_DIR" -type f 2>/dev/null | head -n1)" ]; then
            echo "ðŸ”¥ Priming cache with header preprocessing..."
            make -C "$COMMON" O="$OUT" headers_install prepare 2>&1 | head -n 20 || true
            echo ""
          fi
        fi
        
        BUILD_START=$(date +%s)
        set -o pipefail
        
        make -j"$(nproc --all)" \
          O="$OUT" \
          KCFLAGS="$KCFLAGS" \
          KCPPFLAGS="$KCPPFLAGS" \
          2>&1 | tee build.log
        
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        
        echo "BUILD_START=$BUILD_START" >> "$GITHUB_ENV"
        echo "BUILD_END=$BUILD_END" >> "$GITHUB_ENV"
        echo "BUILD_TIME=$BUILD_TIME" >> "$GITHUB_ENV"
        
        IMG="$OUT/arch/arm64/boot/Image"
        if [ ! -f "$IMG" ]; then
          echo "::error::Kernel Image missing"
          echo "::group::Last 100 lines of build log"
          tail -n 100 build.log || echo "Build log not available"
          echo "::endgroup::"
          exit 1
        fi
        
        IMG_SIZE=$(stat -c%s "$IMG")
        
        echo "============================================"
        echo "âœ… Build Completed Successfully"
        echo "============================================"
        echo "Duration: $((BUILD_TIME / 60))m $((BUILD_TIME % 60))s"
        echo "Image: $(numfmt --to=iec-i --suffix=B "$IMG_SIZE")"
        
        if [ "${{ inputs.clean }}" != "true" ]; then
          echo ""
          echo "ðŸ“Š ccache Post-Build Statistics"
          echo "============================================"
          ccache -s
        fi
        echo "============================================"
        echo "::endgroup::"

    - name: Check Disk Space (Post-Build)
      if: always()
      shell: bash
      run: |
        echo "::group::Disk space report"
        df -h
        echo ""
        echo "Largest directories in workspace:"
        du -h --max-depth=2 "$GITHUB_WORKSPACE" 2>/dev/null | sort -rh | head -n 20 || true
        echo "::endgroup::"

    - name: On failure - Summarize last error
      if: ${{ failure() }}
      shell: bash
      run: |
        set +e
        echo "::group::Build Failure Analysis"
        COMMON="$GITHUB_WORKSPACE/${OP_MODEL}/kernel_platform/common"
        
        echo "## ðŸ”´ Build Failed - Last 120 Lines" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo '```' >> "$GITHUB_STEP_SUMMARY"
        
        if [ -f "$COMMON/build.log" ]; then
          tail -n 120 "$COMMON/build.log" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "build.log not available" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        echo '```' >> "$GITHUB_STEP_SUMMARY"
        echo "::endgroup::"

    - name: ðŸ“Š ccache Post-Build Statistics
      id: ccache_stats
      if: ${{ always() && inputs.clean != 'true' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::ccache final statistics"
        
        export CCACHE_DIR="${{ env.CCACHE_DIR }}"
        
        STATS="$(ccache -s)"
        echo "$STATS"
        echo ""
        
        NORM="$(printf "%s" "$STATS" | sed 's/[[:space:]]\{1,\}/ /g')"
        
        CACHEABLE=$(echo "$NORM" | awk -F'[ /]+' '/^[[:space:]]*Cacheable calls:/ {print $3+0}')
        HITS=$(echo "$NORM" | awk -F'[ /]+' '/^[[:space:]]*Hits:/ {print $3+0}')
        DIRECT=$(echo "$NORM" | awk -F'[ /]+' '/^[[:space:]]*Direct:/ {print $3+0}')
        PREPROC=$(echo "$NORM" | awk -F'[ /]+' '/^[[:space:]]*Preprocessed:/ {print $3+0}')
        MISS=$(echo "$NORM" | awk -F'[ /]+' '/^[[:space:]]*Misses:/ {print $3+0}')
        
        [ -z "${DIRECT}" ] && DIRECT=0
        [ -z "${PREPROC}" ] && PREPROC=0
        [ -z "${HITS}" ] && HITS=$((DIRECT + PREPROC))
        
        [ -z "${CACHEABLE}" ] && CACHEABLE=0
        [ -z "${MISS}" ] && MISS=0
        
        echo "Cache effectiveness analysis:"
        echo "  Cacheable calls: ${CACHEABLE}"
        echo "  Total hits: ${HITS}"
        echo "  Direct hits: ${DIRECT}"
        echo "  Preprocessed hits: ${PREPROC}"
        echo "  Misses: ${MISS}"
        
        if [ "${CACHEABLE}" -gt 0 ] && [ "${HITS}" -gt 0 ]; then
          HIT_RATE=$(awk -v h="$HITS" -v c="$CACHEABLE" 'BEGIN{printf "%.1f", (h/c)*100}')
          DIRECT_RATE=$(awk -v d="$DIRECT" -v c="$CACHEABLE" 'BEGIN{printf "%.1f", (d/c)*100}')
          
          echo ""
          echo "Performance metrics:"
          echo "  Overall hit rate: ${HIT_RATE}%"
          echo "  Direct hit rate: ${DIRECT_RATE}%"
          
          echo "hit_rate=${HIT_RATE}%" >> "$GITHUB_OUTPUT"
          echo "direct_rate=${DIRECT_RATE}%" >> "$GITHUB_OUTPUT"
          echo "ccache_hits=${HITS}" >> "$GITHUB_OUTPUT"
          echo "ccache_misses=${MISS}" >> "$GITHUB_OUTPUT"
          
          if (( $(echo "$HIT_RATE > 90" | bc -l 2>/dev/null || echo "0") )); then
            echo "  Status: â­â­â­â­â­ Excellent"
          elif (( $(echo "$HIT_RATE > 75" | bc -l 2>/dev/null || echo "0") )); then
            echo "  Status: â­â­â­â­ Very Good"
          elif (( $(echo "$HIT_RATE > 50" | bc -l 2>/dev/null || echo "0") )); then
            echo "  Status: â­â­â­ Good"
          elif (( $(echo "$HIT_RATE > 25" | bc -l 2>/dev/null || echo "0") )); then
            echo "  Status: â­â­ Fair"
          else
            echo "  Status: â­ Poor (expected on first build)"
          fi
        else
          echo "âš ï¸ No cacheable calls or hits detected"
          echo "hit_rate=0%" >> "$GITHUB_OUTPUT"
          echo "direct_rate=0%" >> "$GITHUB_OUTPUT"
          echo "ccache_hits=0" >> "$GITHUB_OUTPUT"
          echo "ccache_misses=${MISS}" >> "$GITHUB_OUTPUT"
        fi
        
        CACHE_SIZE=$(du -sh "$CCACHE_DIR" 2>/dev/null | cut -f1 || echo "unknown")
        echo ""
        echo "Cache size: $CACHE_SIZE"
        
        echo "::endgroup::"
        
        echo "## ðŸ“Š ccache Statistics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "$STATS" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${CACHEABLE}" -gt 0 ] && [ "${HITS}" -gt 0 ]; then
          echo "### Cache Performance" >> $GITHUB_STEP_SUMMARY
          echo "- **Hit Rate:** ${HIT_RATE}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Direct Hit Rate:** ${DIRECT_RATE}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Hits:** $HITS" >> $GITHUB_STEP_SUMMARY
          echo "- **Misses:** $MISS" >> $GITHUB_STEP_SUMMARY
          echo "- **Cacheable Calls:** $CACHEABLE" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache Size:** $CACHE_SIZE" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Save ccache (Success)
      if: ${{ success() && inputs.clean != 'true' }}
      uses: actions/cache/save@v4
      continue-on-error: true
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-v3-${{ runner.os }}-${{ env.ANDROID_VER }}-${{ env.KERNEL_VER }}-${{ env.CLANG_VERSION_SHORT }}-${{ env.OP_MODEL }}

    - name: Save ccache (Partial - On Failure)
      if: ${{ failure() && inputs.clean != 'true' }}
      uses: actions/cache/save@v4
      continue-on-error: true
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-v3-${{ runner.os }}-${{ env.ANDROID_VER }}-${{ env.KERNEL_VER }}-${{ env.CLANG_VERSION_SHORT }}-partial-${{ github.run_id }}-${{ env.OP_MODEL }}
        
    - name: Save Build Metadata
      id: save_metadata
      shell: bash
      run: |
        set -euo pipefail
        echo "::group::Save Build Metadata"
        
        CONFIG_DIR="$GITHUB_WORKSPACE/${OP_MODEL}"
        ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
        mkdir -p "$ARTIFACTS_DIR"
        
        KERNEL_VERSION="${KERNEL_FULL_VER:-}"
        SUKISU_VERSION="${SUKISUVER:-}"
        SUSFS_VERSION="${SUSVER:-}"
        
        if [ -z "$KERNEL_VERSION" ] && [ -f "$ARTIFACTS_DIR/kernel_version.txt" ]; then
          KERNEL_VERSION=$(cat "$ARTIFACTS_DIR/kernel_version.txt")
        fi
        
        if [ -z "$SUKISU_VERSION" ]; then
          KSU_DIR="$CONFIG_DIR/kernel_platform/KernelSU"
          if [ -d "$KSU_DIR" ]; then
            cd "$KSU_DIR"
            for b in main master susfs-main; do
              if git show-ref --verify --quiet "refs/heads/$b" 2>/dev/null || \
                 git show-ref --verify --quiet "refs/remotes/origin/$b" 2>/dev/null; then
                commit_count=$(git rev-list --count "$b" 2>/dev/null || echo 13000)
                SUKISU_VERSION=$((commit_count + 10700))
                break
              fi
            done
          fi
        fi
        
        if [ -z "$SUSFS_VERSION" ]; then
          SUSFS_HEADER="$CONFIG_DIR/kernel_platform/common/include/linux/susfs.h"
          if [ -f "$SUSFS_HEADER" ]; then
            SUSFS_VERSION=$(grep '#define SUSFS_VERSION' "$SUSFS_HEADER" | awk -F'"' '{print $2}')
          fi
        fi
        
        KERNEL_VERSION="${KERNEL_VERSION:-unknown}"
        SUKISU_VERSION="${SUKISU_VERSION:-unknown}"
        SUSFS_VERSION="${SUSFS_VERSION:-unknown}"
        
        echo "kernel_version=${KERNEL_VERSION}" >> "$GITHUB_OUTPUT"
        echo "sukisu_version=${SUKISU_VERSION}" >> "$GITHUB_OUTPUT"
        echo "susfs_version=${SUSFS_VERSION}" >> "$GITHUB_OUTPUT"
        
        echo "KERNEL_VERSION=${KERNEL_VERSION}" >> "$GITHUB_ENV"
        echo "SUKISU_VERSION=${SUKISU_VERSION}" >> "$GITHUB_ENV"
        echo "SUSFS_VERSION=${SUSFS_VERSION}" >> "$GITHUB_ENV"
        
        echo "âœ… Metadata saved:"
        echo "   - Kernel: ${KERNEL_VERSION}"
        echo "   - SukiSU: ${SUKISU_VERSION}"
        echo "   - SUSFS: ${SUSFS_VERSION}"
        
        echo "::endgroup::"

    - name: Collect Build Stats / Validate Image
      id: collect_stats
      shell: bash
      run: |
        set -euo pipefail
        
        KERNEL_PATH="$GITHUB_WORKSPACE/${OP_MODEL}/kernel_platform"
        COMMON="$KERNEL_PATH/common"
        OUT="$COMMON/out"
        IMG="$OUT/arch/arm64/boot/Image"
        
        if [ -f "$COMMON/build.log" ]; then
          WARNINGS_COUNT="$(grep -ciE '\bwarning:' "$COMMON/build.log" || true)"
          [ -n "$WARNINGS_COUNT" ] || WARNINGS_COUNT="0"
        else
          WARNINGS_COUNT="0"
        fi
        
        if [ ! -f "$IMG" ]; then
          echo "::error::Kernel Image not found at: $IMG"
          exit 1
        fi
        
        if ! file "$IMG" | grep -qi 'ARM64'; then
          echo "::error::Image is not ARM64 format"
          file "$IMG"
          exit 1
        fi
        
        IMG_SIZE=$(stat -c %s "$IMG")
        MIN_SIZE=6102400
        if [ "$IMG_SIZE" -lt "$MIN_SIZE" ]; then
          echo "::error::Image size too small: $(numfmt --to=iec-i --suffix=B "$IMG_SIZE")"
          exit 1
        fi
        
        IMG_SHA256=$(sha256sum "$IMG" | awk '{print $1}')
        BUILD_TIME="${BUILD_TIME:-0}"
        
        printf 'warnings_count=%s\n' "$WARNINGS_COUNT" >> "$GITHUB_OUTPUT"
        printf 'image_sha256=%s\n' "$IMG_SHA256" >> "$GITHUB_OUTPUT"
        printf 'build_time=%s\n' "$BUILD_TIME" >> "$GITHUB_OUTPUT"
        
        echo "âœ… Validation passed:"
        echo "   - Warnings: $WARNINGS_COUNT"
        echo "   - Image size: $(numfmt --to=iec-i --suffix=B "$IMG_SIZE")"
        echo "   - SHA256: $IMG_SHA256"
        echo "   - Build time: ${BUILD_TIME}s"

    - name: Download and Package ZRAM Module
      if: ${{ inputs.enable_zram == 'true' }}
      id: zram_find
      shell: bash
      continue-on-error: true
      run: |
        set -euo pipefail
        echo "::group::Download and package ZRAM module"
        
        echo "Fetching latest ZRAM module release..."
        
        retries=3
        download_url=""
        
        for attempt in $(seq 1 $retries); do
          echo "Attempt $attempt of $retries..."
          
          download_url=$(curl -fsSL --retry 3 --connect-timeout 30 \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/Bouteillepleine/ZRAM-Module/releases/latest" 2>/dev/null | \
            jq -r '.assets[] | select(.name | test("ZRAM-Module-.*\\.zip")) | .browser_download_url' | \
            head -n 1 || true)
          
          if [ -n "$download_url" ]; then
            echo "Found download URL: $download_url"
            break
          fi
          
          if [ $attempt -lt $retries ]; then
            echo "âš ï¸ Failed to get download URL, retrying in 5 seconds..."
            sleep 5
          fi
        done
        
        if [ -z "$download_url" ]; then
          echo "::warning::Failed to fetch ZRAM module download URL after $retries attempts"
          echo "upload=false" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"
          exit 0
        fi
        
        echo "Downloading ZRAM module from: $download_url"
        
        ZRAM_ZIP_NAME=$(basename "$download_url")
        
        if ! curl -fsSL --retry 3 --connect-timeout 30 -o "$ZRAM_ZIP_NAME" "$download_url"; then
          echo "::warning::Failed to download ZRAM module ZIP"
          echo "upload=false" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"
          exit 0
        fi
        
        if [ ! -f "$ZRAM_ZIP_NAME" ]; then
          echo "::warning::ZRAM module ZIP not found after download"
          echo "upload=false" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"
          exit 0
        fi
        
        ZIP_SIZE=$(stat -c%s "$ZRAM_ZIP_NAME")
        if [ "$ZIP_SIZE" -lt 1024 ]; then
          echo "::warning::Downloaded ZRAM ZIP is too small (${ZIP_SIZE} bytes)"
          rm -f "$ZRAM_ZIP_NAME"
          echo "upload=false" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"
          exit 0
        fi
        
        echo "âœ… ZRAM module ZIP downloaded successfully"
        echo "   File: $ZRAM_ZIP_NAME"
        echo "   Size: $(numfmt --to=iec-i --suffix=B "$ZIP_SIZE")"
        
        echo "Extracting ZRAM module..."
        
        EXTRACT_DIR="ZRAM-Module-Extract"
        mkdir -p "$EXTRACT_DIR"
        
        if ! unzip -q "$ZRAM_ZIP_NAME" -d "$EXTRACT_DIR"; then
          echo "::warning::Failed to extract ZRAM module ZIP"
          rm -rf "$EXTRACT_DIR"
          echo "upload=false" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"
          exit 0
        fi
        
        echo "Searching for compiled zram.ko module..."
        
        CONFIG_DIR="$GITHUB_WORKSPACE/${OP_MODEL}"
        
        search_paths=(
          "$CONFIG_DIR/kernel_platform/common/out"
          "$CONFIG_DIR/kernel_platform/out"
          "$CONFIG_DIR/kernel_platform/common"
          "$CONFIG_DIR/device/qcom"
          "$CONFIG_DIR"
        )
        
        zram_ko_path=""
        
        for search_path in "${search_paths[@]}"; do
          if [ -d "$search_path" ]; then
            echo "Searching in: $search_path"
            zram_ko_path=$(find "$search_path" -type f -name "zram.ko" 2>/dev/null | head -n 1 || true)
            
            if [ -n "$zram_ko_path" ] && [ -f "$zram_ko_path" ]; then
              echo "âœ… Found zram.ko at: $zram_ko_path"
              break
            fi
          fi
        done
        
        if [ -z "$zram_ko_path" ] || [ ! -f "$zram_ko_path" ]; then
          echo "::warning::zram.ko module not found in kernel build output"
          echo "::warning::ZRAM module will be packaged without compiled kernel module"
          echo "upload=partial" >> "$GITHUB_OUTPUT"
        else
          TARGET_DIR="$EXTRACT_DIR/zram"
          mkdir -p "$TARGET_DIR"
          
          echo "Copying compiled zram.ko to ZRAM module package..."
          
          if cp "$zram_ko_path" "$TARGET_DIR/zram.ko"; then
            echo "âœ… Compiled zram.ko copied successfully"
            
            KO_SIZE=$(stat -c%s "$TARGET_DIR/zram.ko")
            KO_SHA256=$(sha256sum "$TARGET_DIR/zram.ko" | awk '{print $1}')
            
            echo "   Size: $(numfmt --to=iec-i --suffix=B "$KO_SIZE")"
            echo "   SHA256: $KO_SHA256"
            
            echo "upload=true" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::Failed to copy zram.ko to package"
            echo "upload=partial" >> "$GITHUB_OUTPUT"
          fi
        fi
        
        echo "Creating final ZRAM module package..."
        
        FINAL_ZRAM_ZIP="ZRAM-Module-Packaged.zip"
        
        cd "$EXTRACT_DIR"
        
        if zip -r9 "../$FINAL_ZRAM_ZIP" ./* -x "*.git*" 2>&1 | tee /tmp/zram_zip.log; then
          cd ..
          
          if [ -f "$FINAL_ZRAM_ZIP" ]; then
            FINAL_SIZE=$(stat -c%s "$FINAL_ZRAM_ZIP")
            FINAL_SHA256=$(sha256sum "$FINAL_ZRAM_ZIP" | awk '{print $1}')
            
            echo "âœ… ZRAM module package created successfully"
            echo "   File: $FINAL_ZRAM_ZIP"
            echo "   Size: $(numfmt --to=iec-i --suffix=B "$FINAL_SIZE")"
            echo "   SHA256: $FINAL_SHA256"
            
            if [ -d "$GITHUB_WORKSPACE/AnyKernel3" ]; then
              echo "Copying ZRAM module to AnyKernel3 directory..."
              
              if cp "$FINAL_ZRAM_ZIP" "$GITHUB_WORKSPACE/AnyKernel3/"; then
                echo "âœ… ZRAM module copied to AnyKernel3"
                ls -lh "$GITHUB_WORKSPACE/AnyKernel3/$FINAL_ZRAM_ZIP"
              else
                echo "::warning::Failed to copy ZRAM module to AnyKernel3"
              fi
            fi
            
            ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
            if [ -d "$ARTIFACTS_DIR" ]; then
              echo "Copying ZRAM module to artifacts directory..."
              
              if cp "$FINAL_ZRAM_ZIP" "$ARTIFACTS_DIR/"; then
                echo "âœ… ZRAM module copied to artifacts"
              fi
            fi
          else
            echo "::warning::Final ZRAM ZIP not created"
            echo "upload=false" >> "$GITHUB_OUTPUT"
          fi
        else
          cd ..
          echo "::warning::Failed to create final ZRAM module package"
          cat /tmp/zram_zip.log || true
          echo "upload=false" >> "$GITHUB_OUTPUT"
        fi
        
        echo "Cleaning up temporary files..."
        rm -rf "$EXTRACT_DIR" "$ZRAM_ZIP_NAME"
        
        echo "::endgroup::"    

    - name: Download SUSFS Module from CI
      shell: bash
      continue-on-error: true
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: |
        set -euo pipefail
        echo "::group::Download SUSFS module"
        
        echo "Fetching latest successful workflow run for branch v1.5.2+..."
        
        LATEST_RUN_ID=$(curl -fsSL --retry 3 --connect-timeout 30 \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs?status=success&per_page=50" | \
          jq -r '.workflow_runs[] | select(.head_branch == "v1.5.2+") | .id' | head -n 1)
        
        if [ -z "$LATEST_RUN_ID" ]; then
          echo "âš ï¸ No successful workflow run found for branch v1.5.2+"
          echo "::warning::SUSFS module will not be included in the kernel ZIP"
          echo "::endgroup::"
          exit 0
        fi
        
        echo "Found workflow run ID: $LATEST_RUN_ID"
        echo "Fetching artifact download URL..."
        
        ARTIFACT_URL=$(curl -fsSL --retry 3 --connect-timeout 30 \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          "https://api.github.com/repos/sidex15/susfs4ksu-module/actions/runs/$LATEST_RUN_ID/artifacts" | \
          jq -r '.artifacts[0].archive_download_url // empty')
        
        if [ -z "$ARTIFACT_URL" ]; then
          echo "âš ï¸ No artifact found in workflow run $LATEST_RUN_ID"
          echo "::warning::SUSFS module will not be included in the kernel ZIP"
          echo "::endgroup::"
          exit 0
        fi
        
        echo "Artifact URL: $ARTIFACT_URL"
        echo "Downloading SUSFS module to AnyKernel3 directory..."
        
        if curl -fsSL --retry 3 --connect-timeout 30 \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             -H "Accept: application/vnd.github+json" \
             -o "$GITHUB_WORKSPACE/AnyKernel3/ksu_module_susfs_1.5.2+_CI.zip" \
             "$ARTIFACT_URL"; then
          
          if [ -f "$GITHUB_WORKSPACE/AnyKernel3/ksu_module_susfs_1.5.2+_CI.zip" ]; then
            FILE_SIZE=$(stat -c%s "$GITHUB_WORKSPACE/AnyKernel3/ksu_module_susfs_1.5.2+_CI.zip")
            
            if [ "$FILE_SIZE" -gt 1024 ]; then
              echo "âœ… SUSFS module downloaded successfully"
              echo "   File: ksu_module_susfs_1.5.2+_CI.zip"
              echo "   Size: $(numfmt --to=iec-i --suffix=B "$FILE_SIZE")"
              ls -lh "$GITHUB_WORKSPACE/AnyKernel3/ksu_module_susfs_1.5.2+_CI.zip"
            else
              echo "âš ï¸ Downloaded file is too small (${FILE_SIZE} bytes)"
              rm -f "$GITHUB_WORKSPACE/AnyKernel3/ksu_module_susfs_1.5.2+_CI.zip"
              echo "::warning::SUSFS module download failed - file too small"
            fi
          else
            echo "âš ï¸ Downloaded file not found"
            echo "::warning::SUSFS module download failed - file missing"
          fi
        else
          echo "âš ï¸ Failed to download SUSFS module"
          echo "::warning::SUSFS module will not be included in the kernel ZIP"
        fi
        
        echo "::endgroup::"

    - name: Create kernel ZIP package
      id: create_zip
      shell: bash
      env:
        KERNEL_VERSION: ${{ env.KERNEL_FULL_VER }}
        SUKISU_VERSION: ${{ env.SUKISUVER }}
      run: |
        set -euo pipefail
        echo "::group::Create kernel ZIP package"
        
        CONFIG_DIR="$GITHUB_WORKSPACE/${OP_MODEL}"
        IMAGE_PATH="$CONFIG_DIR/kernel_platform/common/out/arch/arm64/boot/Image"
        
        if [ ! -f "$IMAGE_PATH" ]; then
          echo "::error::Built Image not found at: $IMAGE_PATH"
          exit 1
        fi
        
        cp "$IMAGE_PATH" "$GITHUB_WORKSPACE/AnyKernel3/Image"
        cd "$GITHUB_WORKSPACE/AnyKernel3"
        
        KERNEL_VER="${KERNEL_VERSION:-${KERNEL_FULL_VER:-unknown}}"
        SUKISU_VER="${SUKISU_VERSION:-${SUKISUVER:-unknown}}"
        
        ZIP_NAME="AnyKernel3_${OP_MODEL}_${KERNEL_VER}_SukiSU_${SUKISU_VER}.zip"
        
        ARTIFACTS_DIR="$CONFIG_DIR/artifacts"
        mkdir -p "$ARTIFACTS_DIR"
        
        echo "Creating flashable ZIP: $ZIP_NAME"
        
        if ! zip -r9 "$ZIP_NAME" ./* \
             -x "*.git*" \
             -x "$ZIP_NAME" \
             -x "README.md" 2>&1 | tee /tmp/zip.log; then
          echo "::error::Failed to create ZIP package"
          exit 1
        fi
        
        mv "$ZIP_NAME" "$ARTIFACTS_DIR/"
        
        ZIP_SIZE=$(stat -c%s "$ARTIFACTS_DIR/$ZIP_NAME")
        ZIP_SHA256=$(sha256sum "$ARTIFACTS_DIR/$ZIP_NAME" | awk '{print $1}')
        
        echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"
        echo "zip_size=$ZIP_SIZE" >> "$GITHUB_OUTPUT"
        echo "zip_sha256=$ZIP_SHA256" >> "$GITHUB_OUTPUT"
        
        echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"
        echo "ZIP_SIZE=$ZIP_SIZE" >> "$GITHUB_ENV"
        echo "ZIP_SHA256=$ZIP_SHA256" >> "$GITHUB_ENV"
        
        echo ""
        echo "âœ… Kernel ZIP created successfully"
        echo "   Name: $ZIP_NAME"
        echo "   Size: $(numfmt --to=iec-i --suffix=B "$ZIP_SIZE")"
        echo "   SHA256: $ZIP_SHA256"
        echo "::endgroup::"

    - name: Generate Build Summary
      if: always()
      shell: bash
      run: |
        set -euo pipefail
        echo "## ðŸŽ¯ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Version |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Device** | ${OP_MODEL} |" >> $GITHUB_STEP_SUMMARY
        echo "| **SoC** | ${OP_SOC} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Kernel** | ${{ steps.save_metadata.outputs.kernel_version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **SukiSU** | v${{ steps.save_metadata.outputs.sukisu_version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **SUSFS** | ${{ steps.save_metadata.outputs.susfs_version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Hook Type** | ${{ inputs.hook }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Optimization** | ${{ inputs.optimize_level }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **ZRAM** | ${{ inputs.enable_zram }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **BBG LSM** | ${{ inputs.lsm }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Fengchi** | ${{ inputs.sched }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ steps.create_zip.outputs.zip_name }}" ]; then
          echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
          echo "**Filename:** \`${{ steps.create_zip.outputs.zip_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${ZIP_SIZE:-}" ]; then
            SIZE_MB=$(echo "scale=2; ${ZIP_SIZE} / 1024 / 1024" | bc)
            echo "**Size:** ${SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${ZIP_SHA256:-}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**SHA256:** \`${ZIP_SHA256}\`" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Build Statistics" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ steps.collect_stats.outputs.build_time }}" ]; then
          BUILD_TIME="${{ steps.collect_stats.outputs.build_time }}"
          BUILD_MIN=$((BUILD_TIME / 60))
          BUILD_SEC=$((BUILD_TIME % 60))
          echo "- **Build Time:** ${BUILD_MIN}m ${BUILD_SEC}s" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ steps.ccache_stats.outputs.hit_rate }}" ]; then
          echo "- **ccache Hit Rate:** ${{ steps.ccache_stats.outputs.hit_rate }}" >> $GITHUB_STEP_SUMMARY
          echo "- ccache Direct Rate: ${{ steps.ccache_stats.outputs.direct_rate }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ccache Hits:** ${{ steps.ccache_stats.outputs.ccache_hits }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ccache Misses:** ${{ steps.ccache_stats.outputs.ccache_misses }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ steps.collect_stats.outputs.warnings_count }}" ]; then
          echo "- **Compiler Warnings:** ${{ steps.collect_stats.outputs.warnings_count }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ steps.collect_stats.outputs.image_sha256 }}" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Checksums" >> $GITHUB_STEP_SUMMARY
          echo "- **Kernel Image SHA256:** \`${{ steps.collect_stats.outputs.image_sha256 }}\`" >> $GITHUB_STEP_SUMMARY
        fi
