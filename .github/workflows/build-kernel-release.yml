name: Build OnePlus Kernels

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      make_release:
        description: 'Create release'
        type: boolean
        default: false
      op_model:
        description: 'Kernel to build'
        type: choice
        options:
          - ALL
          - android15-6.6
          - android14-6.1
          - android14-5.15
          - android13-5.15
          - android13-5.10
          - android12-5.10
          - OP13-CPH
          - OP13-PJZ
          - OP13r
          - OP13S
          - OP13T
          - OP12
          - OP12r
          - OP11
          - OP11r
          - OP10pro
          - OP10t
          - OP-Nord-5
          - OP-NORD-4
          - OP-NORD-4-CE
          - OP-NORD-CE4-LITE
          - OP-ACE-5-PRO
          - OP-ACE-5
          - OP-ACE-3-PRO
          - OP-ACE-3V
          - OP-ACE-2-PRO
          - OP-ACE-2
          - OP-OPEN
          - OP-PAD-3
          - OP-PAD-2-PRO
          - OP-PAD-2
          - OP-PAD-PRO
        default: ALL
      hook:
        description: 'Hook type'
        type: choice
        options: [kprobe, manual, tracepoint]
        default: manual
      lsm:
        description: 'BBG LSM'
        type: boolean
        default: false
      sched:
        description: 'Fengchi (6.6)'
        type: boolean
        default: false
      enable_zram:
        description: 'ZRAM'
        type: boolean
        default: false
      optimize_level:
        description: 'Optimization'
        type: choice
        options: [O2, O3]
        default: O2
      clean_build:
        description: 'Clean build'
        type: boolean
        default: false

jobs:
  setup:
    name: ğŸ”§ Setup Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      total_configs: ${{ steps.matrix.outputs.total_configs }}
      filtered_count: ${{ steps.matrix.outputs.filtered_count }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: configs/

      - name: ğŸ” Generate build matrix
        id: matrix
        run: |
          set -euo pipefail
          echo "::group::Matrix Generation"
          
          echo "ğŸ“‹ Validating configs directory..."
          [ -d configs ] || { echo "::error::configs/ directory not found"; exit 1; }
          
          echo "ğŸ” Scanning JSON configuration files..."
          tmp=()
          config_count=0
          for f in configs/*.json; do
            if [ -f "$f" ]; then
              echo "  â†’ Validating: $(basename "$f")"
              if jq empty "$f" 2>/dev/null; then
                tmp+=("$(jq -c '.' "$f")")
                ((config_count++))
              else
                echo "  âš ï¸ Invalid JSON: $f"
              fi
            fi
          done
          
          [ ${#tmp[@]} -gt 0 ] || { echo "::error::No valid configs found"; exit 1; }
          echo "âœ… Found $config_count valid configuration(s)"
          
          printf '%s\n' "${tmp[@]}" | jq -s '.' > m.json
          
          input="${{ inputs.op_model }}"
          echo ""
          echo "ğŸ¯ Filter criteria: $input"
          
          if [[ "$input" == "ALL" ]]; then
            filter='.'
            echo "  â†’ Building ALL configurations"
          elif [[ "$input" == android*-* ]]; then
            av="${input%-*}"
            kv="${input#*-}"
            filter="map(select(.android_version==\"$av\" and .kernel_version==\"$kv\"))"
            echo "  â†’ Filtering by Android: $av, Kernel: $kv"
          else
            filter="map(select(.model==\"$input\"))"
            echo "  â†’ Filtering by model: $input"
          fi
          
          filtered=$(jq -c "$filter" m.json)
          filtered_count=$(jq 'length' <<<"$filtered")
          
          [ "$filtered_count" -gt 0 ] || { 
            echo "::error::No configurations match filter: $input"
            exit 1
          }
          
          echo ""
          echo "ğŸ“Š Matrix Statistics:"
          echo "  â€¢ Total configs: $config_count"
          echo "  â€¢ Filtered configs: $filtered_count"
          echo "  â€¢ Match rate: $(awk "BEGIN {printf \"%.1f\", ($filtered_count/$config_count)*100}")%"
          
          echo ""
          echo "ğŸ—ï¸ Build targets:"
          jq -r '.[] | "  â†’ \(.model) (\(.android_version)-\(.kernel_version))"' <<<"$filtered"
          
          echo ""
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          jq -n --argjson i "$filtered" '{include:$i}' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "total_configs=$config_count" >> $GITHUB_OUTPUT
          echo "filtered_count=$filtered_count" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"

      - name: ğŸ“Š Matrix Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸ”§ Build Matrix Configuration
          
          ### ğŸ“‹ Statistics
          - **Total Configurations:** ${{ steps.matrix.outputs.total_configs }}
          - **Selected for Build:** ${{ steps.matrix.outputs.filtered_count }}
          - **Filter Applied:** \`${{ inputs.op_model }}\`
          
          ### âš™ï¸ Build Options
          - **Hook Type:** ${{ inputs.hook }}
          - **BBG LSM:** ${{ inputs.lsm }}
          - **Fengchi Scheduler:** ${{ inputs.sched }}
          - **ZRAM:** ${{ inputs.enable_zram }}
          - **Optimization:** ${{ inputs.optimize_level }}
          - **Clean Build:** ${{ inputs.clean_build }}
          
          ---
          EOF

  build:
    name: ğŸ—ï¸ ${{ matrix.model }} (${{ matrix.android_version }}-${{ matrix.kernel_version }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix: ${{ fromJSON(needs.setup.outputs.matrix) }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ’¾ System information
        run: |
          echo "::group::System Information"
          echo "ğŸ–¥ï¸ Runner Details:"
          echo "  â€¢ OS: $(lsb_release -ds)"
          echo "  â€¢ Kernel: $(uname -r)"
          echo "  â€¢ CPU: $(nproc) cores"
          echo "  â€¢ RAM: $(free -h | awk '/^Mem:/ {print $2}')"
          echo "  â€¢ Disk: $(df -h / | awk 'NR==2 {print $4}') available"
          echo ""
          echo "ğŸ“¦ Build Configuration:"
          echo "  â€¢ Model: ${{ matrix.model }}"
          echo "  â€¢ SoC: ${{ matrix.soc }}"
          echo "  â€¢ Android: ${{ matrix.android_version }}"
          echo "  â€¢ Kernel: ${{ matrix.kernel_version }}"
          echo "  â€¢ Branch: ${{ matrix.branch }}"
          echo "::endgroup::"

      - name: â±ï¸ Build start timestamp
        id: start_time
        run: echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Execute build
        id: build
        uses: ./.github/actions
        with:
          op_config_json: ${{ toJSON(matrix) }}
          ksu_meta: 'susfs-main/âš¡Ultraâš¡/'
          hook: ${{ inputs.hook }}
          lsm: ${{ inputs.lsm }}
          enable_zram: ${{ inputs.enable_zram }}
          sched: ${{ inputs.sched }}
          optimize_level: ${{ inputs.optimize_level }}
          clean: ${{ inputs.clean_build }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: â±ï¸ Calculate build duration
        id: duration
        if: always()
        run: |
          start=${{ steps.start_time.outputs.timestamp }}
          end=$(date +%s)
          duration=$((end - start))
          minutes=$((duration / 60))
          seconds=$((duration % 60))
          echo "duration=${duration}" >> $GITHUB_OUTPUT
          echo "formatted=${minutes}m ${seconds}s" >> $GITHUB_OUTPUT
          
          echo "::notice::Build completed in ${minutes}m ${seconds}s"

      - name: âœ… Validate build outputs
        run: |
          echo "::group::Output Validation"
          
          required_outputs=(
            "kernel_version:${{ steps.build.outputs.kernel_version }}"
            "sukisu_version:${{ steps.build.outputs.sukisu_version }}"
            "susfs_version:${{ steps.build.outputs.susfs_version }}"
            "image_sha256:${{ steps.build.outputs.image_sha256 }}"
            "zip_name:${{ steps.build.outputs.zip_name }}"
          )
          
          all_valid=true
          for item in "${required_outputs[@]}"; do
            key="${item%%:*}"
            value="${item#*:}"
            if [ -z "$value" ]; then
              echo "::error::Missing output: $key"
              all_valid=false
            else
              echo "âœ… $key: $value"
            fi
          done
          
          $all_valid || exit 1
          echo "::endgroup::"

      - name: ğŸ“Š Build statistics
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸ“Š Build Statistics - ${{ matrix.model }}
          
          ### â±ï¸ Performance
          - **Build Duration:** ${{ steps.duration.outputs.formatted }}
          - **ccache Hit Rate:** ${{ steps.build.outputs.ccache_hit_rate || 'N/A' }}
          - **Warnings Count:** ${{ steps.build.outputs.warnings_count || '0' }}
          
          ### ğŸ“¦ Artifacts
          - **Kernel Version:** ${{ steps.build.outputs.kernel_version }}
          - **SukiSU Version:** ${{ steps.build.outputs.sukisu_version }}
          - **SUSFS Version:** ${{ steps.build.outputs.susfs_version }}
          - **Output File:** \`${{ steps.build.outputs.zip_name }}\`
          - **Image SHA256:** \`${{ steps.build.outputs.image_sha256 }}\`
          
          ### ğŸ”§ Configuration
          - **Model:** ${{ matrix.model }}
          - **SoC:** ${{ matrix.soc }}
          - **Android:** ${{ matrix.android_version }}
          - **Kernel:** ${{ matrix.kernel_version }}
          - **Hook:** ${{ inputs.hook }}
          - **Optimization:** ${{ inputs.optimize_level }}
          
          ---
          EOF

      - name: ğŸ“¤ Upload kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.model }}-kernel
          path: ${{ matrix.model }}/artifacts/${{ steps.build.outputs.zip_name }}
          retention-days: 30
          compression-level: 0
          if-no-files-found: error

      - name: ğŸ‰ Build success notification
        if: success()
        run: |
          echo "::notice title=${{ matrix.model }}::âœ… Build completed successfully in ${{ steps.duration.outputs.formatted }}"

  release:
    name: ğŸš€ Create Release
    needs: build
    if: ${{ inputs.make_release && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Install dependencies
        run: |
          echo "::group::Install jq"
          command -v jq >/dev/null || {
            sudo apt-get update -qq
            sudo apt-get install -y jq
          }
          jq --version
          echo "::endgroup::"

      - name: ğŸ·ï¸ Generate release tag
        id: tag
        run: |
          echo "::group::Tag Generation"
          
          git fetch --tags -q
          echo "ğŸ“‹ Fetching existing tags..."
          
          latest=$(gh api repos/${{ github.repository }}/tags \
            --paginate \
            --jq '[.[]|.name|select(test("^v1\\.5\\.12-r\\d+$"))]|sort_by(sub(".*-r","")|tonumber)|last//empty')
          
          if [ -z "$latest" ]; then
            new="v1.5.12-r0"
            echo "ğŸ†• No previous releases found"
          else
            rev=$(sed -n 's/.*-r\([0-9]\+\)$/\1/p' <<<"$latest")
            new="v1.5.12-r$((rev + 1))"
            echo "ğŸ“Œ Latest release: $latest"
          fi
          
          echo "ğŸ¯ New release tag: $new"
          echo "tag=$new" >> $GITHUB_OUTPUT
          
          if git rev-parse -q --verify "refs/tags/$new" >/dev/null || \
             git ls-remote --tags origin "$new" | grep -q "$new$"; then
            echo "âš ï¸ Tag already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Creating new tag"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$new" -m "Release $new - SukiSU Ultra & SUSFS v1.5.12"
            git push origin "refs/tags/$new"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
          
          echo "::endgroup::"

      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“¦ Prepare release assets
        id: assets
        run: |
          echo "::group::Asset Preparation"
          
          mkdir -p release
          echo "ğŸ“‚ Collecting kernel packages..."
          
          count=0
          total_size=0
          
          while IFS= read -r -d '' zip; do
            cp "$zip" release/
            size=$(stat -c%s "$zip" 2>/dev/null || stat -f%z "$zip")
            total_size=$((total_size + size))
            ((count++))
            echo "  âœ… $(basename "$zip") ($(numfmt --to=iec-i --suffix=B $size 2>/dev/null || echo "$size bytes"))"
          done < <(find artifacts -name '*.zip' -print0)
          
          [ "$count" -gt 0 ] || { 
            echo "::error::No kernel packages found"
            exit 1
          }
          
          echo ""
          echo "ğŸ“Š Release Statistics:"
          echo "  â€¢ Total packages: $count"
          echo "  â€¢ Total size: $(numfmt --to=iec-i --suffix=B $total_size 2>/dev/null || echo "$total_size bytes")"
          
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "size=$(numfmt --to=iec-i --suffix=B $total_size 2>/dev/null || echo "$total_size bytes")" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"

      - name: ğŸ“ Generate release notes
        run: |
          cat > notes.md << 'EOF'
          # ğŸ‰ SukiSU Ultra + SUSFS v1.5.12
          
          ## ğŸ“¦ Release Information
          
          This release contains **${{ steps.assets.outputs.count }}** kernel package(s) with a total size of **${{ steps.assets.outputs.size }}**.
          
          ### âœ¨ Features
          - âš¡ **SukiSU Ultra** - Advanced root management
          - ğŸ›¡ï¸ **SUSFS** - Secure userspace filesystem
          - ğŸ”§ **Hook Type:** ${{ inputs.hook }}
          - ğŸš€ **Optimization:** ${{ inputs.optimize_level }}
          
          ### ğŸ“‹ Build Configuration
          - **BBG LSM:** ${{ inputs.lsm }}
          - **Fengchi Scheduler:** ${{ inputs.sched }}
          - **ZRAM Support:** ${{ inputs.enable_zram }}
          - **Clean Build:** ${{ inputs.clean_build }}
          
          ### ğŸ“¥ Installation
          1. Download the appropriate kernel package for your device
          2. Flash via Suki Manager to enable KPM or Kernel Flasher
          3. Reboot and enjoy!
          
          ### âš ï¸ Important Notes
          - Always backup your data before flashing
          - This is a prerelease version - use at your own risk
          - Report issues on GitHub with detailed logs
          
          ---
          *Built with â¤ï¸ using GitHub Actions*
          EOF

      - name: ğŸš€ Create GitHub release
        if: steps.tag.outputs.exists != 'true'
        run: |
          echo "::group::Release Creation"
          
          gh release create "${{ steps.tag.outputs.tag }}" \
            --repo "${{ github.repository }}" \
            --title "ğŸ‰ OnePlus Kernels - SukiSU Ultra & SUSFS v1.5.12" \
            --notes-file notes.md \
            --prerelease \
            release/*.zip
          
          echo "âœ… Release created: ${{ steps.tag.outputs.tag }}"
          echo "::endgroup::"

      - name: ğŸ“Š Release summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸš€ Release Created
          
          ### ğŸ·ï¸ Tag Information
          - **Release Tag:** \`${{ steps.tag.outputs.tag }}\`
          - **Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.tag }}
          
          ### ğŸ“¦ Assets
          - **Package Count:** ${{ steps.assets.outputs.count }}
          - **Total Size:** ${{ steps.assets.outputs.size }}
          
          ### âœ… Status
          Release successfully published to GitHub! ğŸ‰
          
          ---
          EOF

      - name: ğŸŠ Success notification
        run: |
          echo "::notice::ğŸ‰ Release ${{ steps.tag.outputs.tag }} created successfully with ${{ steps.assets.outputs.count }} package(s)"
