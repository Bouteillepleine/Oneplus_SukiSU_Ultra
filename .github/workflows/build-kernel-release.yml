name: Build OnePlus Kernels

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      make_release:
        description: 'Create release'
        type: boolean
        default: false
      op_model:
        description: 'Kernel to build'
        type: choice
        options:
          - ALL
          - android15-6.6
          - android14-6.1
          - android14-5.15
          - android13-5.15
          - android13-5.10
          - android12-5.10
          - OP13-CPH
          - OP13-PJZ
          - OP13r
          - OP13S
          - OP13T
          - OP12
          - OP12r
          - OP11
          - OP11r
          - OP10pro
          - OP10t
          - OP-Nord-5
          - OP-NORD-4
          - OP-NORD-4-CE
          - OP-NORD-CE4-LITE
          - OP-ACE-5-PRO
          - OP-ACE-5
          - OP-ACE-3-PRO
          - OP-ACE-3V
          - OP-ACE-2-PRO
          - OP-ACE-2
          - OP-OPEN
          - OP-PAD-3
          - OP-PAD-2-PRO
          - OP-PAD-2
          - OP-PAD-PRO
        default: ALL
      hook:
        description: 'Hook type'
        type: choice
        options: [kprobe, manual, tracepoint]
        default: manual
      lsm:
        description: 'BBG LSM'
        type: boolean
        default: false
      sched:
        description: 'Fengchi (6.6)'
        type: boolean
        default: false
      enable_zram:
        description: 'ZRAM'
        type: boolean
        default: false
      optimize_level:
        description: 'Optimization'
        type: choice
        options: [O2, O3]
        default: O2
      clean_build:
        description: 'Clean build'
        type: boolean
        default: false

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: configs/

      - id: matrix
        run: |
          set -e
          [ -d configs ] || exit 1
          
          tmp=()
          for f in configs/*.json; do
            jq empty "$f" 2>/dev/null && tmp+=("$(jq -c '.' "$f")")
          done
          [ ${#tmp[@]} -gt 0 ] || exit 1
          
          printf '%s\n' "${tmp[@]}" | jq -s '.' > m.json
          
          input="${{ inputs.op_model }}"
          if [[ "$input" == "ALL" ]]; then
            filter='.'
          elif [[ "$input" == android*-* ]]; then
            av="${input%-*}"; kv="${input#*-}"
            filter="map(select(.android_version==\"$av\" and .kernel_version==\"$kv\"))"
          else
            filter="map(select(.model==\"$input\"))"
          fi
          
          filtered=$(jq -c "$filter" m.json)
          [ "$(jq 'length' <<<"$filtered")" -gt 0 ] || exit 1
          
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          jq -n --argjson i "$filtered" '{include:$i}' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.setup.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - id: build
        uses: ./.github/actions
        with:
          op_config_json: ${{ toJSON(matrix) }}
          ksu_meta: 'susfs-main/⚡Ultra⚡/'
          hook: ${{ inputs.hook }}
          lsm: ${{ inputs.lsm }}
          enable_zram: ${{ inputs.enable_zram }}
          sched: ${{ inputs.sched }}
          optimize_level: ${{ inputs.optimize_level }}
          clean: ${{ inputs.clean_build }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - run: |
          for k in kernel_version sukisu_version susfs_version image_sha256 zip_name; do
            case "$k" in
              kernel_version) v="${{ steps.build.outputs.kernel_version }}" ;;
              sukisu_version) v="${{ steps.build.outputs.sukisu_version }}" ;;
              susfs_version) v="${{ steps.build.outputs.susfs_version }}" ;;
              image_sha256) v="${{ steps.build.outputs.image_sha256 }}" ;;
              zip_name) v="${{ steps.build.outputs.zip_name }}" ;;
            esac
            [ -n "$v" ] || exit 1
          done

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.model }}-kernel
          path: ${{ matrix.model }}/artifacts/${{ steps.build.outputs.zip_name }}
          retention-days: 30
          compression-level: 0

  release:
    needs: build
    if: ${{ inputs.make_release && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: command -v jq >/dev/null || sudo apt-get update -qq && sudo apt-get install -y jq

      - id: tag
        run: |
          git fetch --tags -q
          latest=$(gh api repos/${{ github.repository }}/tags --paginate --jq '[.[]|.name|select(test("^v1\\.5\\.12-r\\d+$"))]|sort_by(sub(".*-r","")|tonumber)|last//empty')
          new=$([ -z "$latest" ] && echo "v1.5.12-r0" || echo "v1.5.12-r$(( $(sed -n 's/.*-r\([0-9]\+\)$/\1/p' <<<"$latest") + 1 ))")
          echo "tag=$new" >> $GITHUB_OUTPUT
          
          if git rev-parse -q --verify "refs/tags/$new" >/dev/null || git ls-remote --tags origin "$new" | grep -q "$new$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$new" -m "Release $new"
            git push origin "refs/tags/$new"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - run: |
          mkdir -p release
          find artifacts -name '*.zip' -exec cp {} release/ \;
          [ "$(find release -name '*.zip' | wc -l)" -gt 0 ] || exit 1

      - run: echo "# SukiSU Ultra + SUSFS v1.5.12" > notes.md

      - if: steps.tag.outputs.exists != 'true'
        run: |
          gh release create "${{ steps.tag.outputs.tag }}" \
            --repo "${{ github.repository }}" \
            --title "OnePlus Kernels - SukiSU Ultra & SUSFS v1.5.12" \
            --notes-file notes.md \
            --prerelease \
            release/*.zip
