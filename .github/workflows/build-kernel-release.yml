name: Build OnePlus Kernels_SukiSu Ultraâš¡

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      make_release:
        description: 'Create release'
        type: boolean
        default: false
      op_model:
        description: 'Select kernels'
        type: choice
        options:
          - ALL
          - android15-6.6
          - android14-6.1
          - android14-5.15
          - android13-5.15
          - android13-5.10
          - android12-5.10
          - OP13-CPH
          - OP13-PJZ
          - OP13r
          - OP13S
          - OP13T
          - OP12
          - OP12r
          - OP11
          - OP11r
          - OP10pro
          - OP10t
          - OP-Nord-5
          - OP-NORD-4
          - OP-NORD-4-CE
          - OP-NORD-CE4-LITE
          - OP-ACE-5-PRO
          - OP-ACE-5
          - OP-ACE-3-PRO
          - OP-ACE-3V
          - OP-ACE-2-PRO
          - OP-ACE-2
          - OP-OPEN
          - OP-PAD-3
          - OP-PAD-2-PRO
          - OP-PAD-2
          - OP-PAD-PRO
        default: ALL
      hook:
        description: 'Hook type'
        type: choice
        options: [kprobe, manual, tracepoint]
        default: manual
      lsm:
        description: 'BBG LSM'
        type: boolean
        default: false
      sched:
        description: 'Fengchi scheduler'
        type: boolean
        default: false
      enable_zram:
        description: 'ZRAM'
        type: boolean
        default: false
      optimize_level:
        description: 'Optimization'
        type: choice
        options: [O2, O3]
        default: O2
      cache_strategy:
        description: 'Cache strategy'
        type: choice
        options:
          - smart      # Reuse previous builds (recommended)
          - clean      # Start fresh
          - aggressive # Maximum reuse across devices
        default: smart

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.result }}
      device_count: ${{ steps.matrix.outputs.count }}
      max_parallel: ${{ steps.optimize.outputs.max_parallel }}
      cache_strategy: ${{ steps.cache_config.outputs.strategy }}
    steps:
      - name: ðŸ“¥ Checkout configs
        uses: actions/checkout@v4
        with:
          sparse-checkout: configs/

      - name: ðŸ” Generate build matrix
        id: matrix
        run: |
          echo "::group::Matrix generation"
          
          [ ! -d configs ] && { echo "::error::configs/ not found"; exit 1; }
          
          echo "[" > matrix.json
          first=true
          for f in configs/*.json; do
            jq empty "$f" 2>/dev/null || continue
            [ "$first" = false ] && echo "," >> matrix.json
            jq -c '.' "$f" >> matrix.json
            first=false
          done
          echo "]" >> matrix.json
          
          input="${{ inputs.op_model }}"
          echo "ðŸ“‹ Filter: $input"
          
          if [[ "$input" == "ALL" ]]; then
            filter="."
          elif [[ "$input" == android*-* ]]; then
            av="${input%-*}"
            kv="${input#*-}"
            filter="map(select(.android_version==\"$av\" and .kernel_version==\"$kv\"))"
          else
            filter="map(select(.model==\"$input\"))"
          fi
          
          result=$(jq -c "$filter" matrix.json)
          count=$(jq 'length' <<<"$result")
          
          [ "$count" -eq 0 ] && { echo "::error::No matching devices"; exit 1; }
          
          echo "âœ… Found $count device(s) to build"
          echo ""
          echo "Devices:"
          jq -r '.[] | "  - \(.model) (\(.android_version)-\(.kernel_version))"' <<<"$result"
          
          echo "result=$(jq -cn --argjson i "$result" '{include:$i}')" >> $GITHUB_OUTPUT
          echo "count=$count" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"

      - name: ðŸŽ¯ Optimize Build Strategy
        id: optimize
        run: |
          echo "::group::Calculate optimal concurrency"
          
          DEVICE_COUNT=${{ steps.matrix.outputs.count }}
          
          # Calculate optimal max-parallel based on device count
          # This prevents resource exhaustion while maximizing throughput
          if [ "$DEVICE_COUNT" -le 2 ]; then
            MAX_PARALLEL=2
            echo "ðŸ“Š Small batch: Building $DEVICE_COUNT device(s) with max-parallel=$MAX_PARALLEL"
          elif [ "$DEVICE_COUNT" -le 4 ]; then
            MAX_PARALLEL=2
            echo "ðŸ“Š Medium batch: Building $DEVICE_COUNT device(s) with max-parallel=$MAX_PARALLEL"
          elif [ "$DEVICE_COUNT" -le 8 ]; then
            MAX_PARALLEL=2
            echo "ðŸ“Š Large batch: Building $DEVICE_COUNT device(s) with max-parallel=$MAX_PARALLEL"
          else
            MAX_PARALLEL=1
            echo "ðŸ“Š Very large batch: Building $DEVICE_COUNT device(s) with max-parallel=$MAX_PARALLEL"
          fi
          
          echo "max_parallel=$MAX_PARALLEL" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"

      - name: ðŸ”§ Configure Cache Strategy
        id: cache_config
        run: |
          echo "::group::Cache strategy configuration"
          
          STRATEGY="${{ inputs.cache_strategy }}"
          
          case "$STRATEGY" in
            clean)
              echo "ðŸ§¹ Clean build: Starting with fresh cache"
              echo "strategy=clean" >> $GITHUB_OUTPUT
              echo "restore_keys=" >> $GITHUB_OUTPUT
              ;;
            aggressive)
              echo "âš¡ Aggressive caching: Maximum reuse across all builds"
              echo "strategy=aggressive" >> $GITHUB_OUTPUT
              echo "restore_keys=ccache-" >> $GITHUB_OUTPUT
              ;;
            smart|*)
              echo "ðŸŽ¯ Smart caching: Reuse previous builds for same device"
              echo "strategy=smart" >> $GITHUB_OUTPUT
              echo "restore_keys=ccache-\${{ matrix.model }}-" >> $GITHUB_OUTPUT
              ;;
          esac
          
          echo "::endgroup::"

      - name: ðŸ“Š Build plan summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ¯ Build Plan
          
          **Target:** \`${{ inputs.op_model }}\`  
          **Devices:** ${{ steps.matrix.outputs.count }}  
          **Max Parallel:** ${{ steps.optimize.outputs.max_parallel }}  
          **Cache Strategy:** \`${{ inputs.cache_strategy }}\`
          
          ### ðŸ”§ Configuration
          | Setting | Value |
          |---------|-------|
          | **Hook** | \`${{ inputs.hook }}\` |
          | **Optimization** | \`${{ inputs.optimize_level }}\` |
          | **ZRAM** | ${{ inputs.enable_zram }} |
          | **BBG LSM** | ${{ inputs.lsm }} |
          | **Fengchi** | ${{ inputs.sched }} |
          | **Create Release** | ${{ inputs.make_release }} |
          
          ### ðŸ“± Devices to Build
          EOF
          
          jq -r '.include[] | "- **\(.model)** - \(.android_version)-\(.kernel_version)"' matrix.json >> $GITHUB_STEP_SUMMARY

      - name: ðŸ¥ Pre-Build Health Check
        run: |
          echo "::group::System health check"
          
          echo "ðŸ“Š Available resources:"
          echo ""
          echo "**Disk:**"
          df -h / | tail -n1
          echo ""
          echo "**Memory:**"
          free -h
          echo ""
          echo "**CPU:**"
          echo "  Cores: $(nproc --all)"
          echo "  Model: $(lscpu | grep 'Model name' | cut -d: -f2 | xargs)"
          
          # Check if we have enough disk space
          AVAILABLE=$(df / | tail -n1 | awk '{print $4}')
          REQUIRED=$((50 * 1024 * 1024))  # 50GB in KB
          
          if [ "$AVAILABLE" -lt "$REQUIRED" ]; then
            echo "::warning::Low disk space: $(numfmt --to=iec-i --suffix=B $((AVAILABLE * 1024)))"
            echo "::warning::Recommended: At least 50GB free"
          else
            echo "âœ… Sufficient disk space available"
          fi
          
          echo "::endgroup::"

  build:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hour timeout per build
    strategy:
      fail-fast: false
      max-parallel: ${{ fromJSON(needs.setup.outputs.max_parallel) }}
      matrix: ${{ fromJSON(needs.setup.outputs.matrix) }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”¨ Build ${{ matrix.model }}
        id: build
        uses: ./.github/actions
        with:
          op_config_json: ${{ toJSON(matrix) }}
          ksu_meta: 'susfs-main/âš¡Ultraâš¡/'
          hook: ${{ inputs.hook }}
          lsm: ${{ inputs.lsm }}
          enable_zram: ${{ inputs.enable_zram }}
          sched: ${{ inputs.sched }}
          optimize_level: ${{ inputs.optimize_level }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Build statistics
        if: always()
        run: |
          echo "::group::Build Statistics for ${{ matrix.model }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Device: ${{ matrix.model }}"
          echo "Status: ${{ job.status }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "${{ steps.build.outcome }}" = "success" ]; then
            echo ""
            echo "âœ… Build completed successfully"
            echo ""
            echo "ðŸ“¦ Outputs:"
            echo "  - Kernel: ${{ steps.build.outputs.kernel_version }}"
            echo "  - SukiSU: v${{ steps.build.outputs.sukisu_version }}"
            echo "  - SUSFS: ${{ steps.build.outputs.susfs_version }}"
            
            BUILD_TIME="${{ steps.build.outputs.build_time }}"
            if [ -n "$BUILD_TIME" ] && [ "$BUILD_TIME" != "0" ]; then
              BUILD_MIN=$((BUILD_TIME / 60))
              BUILD_SEC=$((BUILD_TIME % 60))
              echo "  - Build time: ${BUILD_TIME}s (${BUILD_MIN}m ${BUILD_SEC}s)"
            else
              echo "  - Build time: Not available"
            fi
            
            if [ -n "${{ steps.build.outputs.ccache_hit_rate }}" ]; then
              echo "  - ccache hit rate: ${{ steps.build.outputs.ccache_hit_rate }}% âš¡"
            fi
            
            echo "  - ZIP: ${{ steps.build.outputs.zip_name }}"
            
            ZIP_SIZE="${{ steps.build.outputs.zip_size }}"
            if [ -n "$ZIP_SIZE" ]; then
              ZIP_SIZE_MB=$(echo "scale=2; $ZIP_SIZE / 1024 / 1024" | bc)
              echo "  - Size: ${ZIP_SIZE_MB} MB"
            fi
            
            if [ -n "${{ steps.build.outputs.warnings_count }}" ]; then
              WARNINGS="${{ steps.build.outputs.warnings_count }}"
              if [ "$WARNINGS" -gt 100 ]; then
                echo "  - Warnings: $WARNINGS âš ï¸"
              else
                echo "  - Warnings: $WARNINGS"
              fi
            fi
            
            if [ -n "${{ steps.build.outputs.image_sha256 }}" ]; then
              echo "  - Image SHA256: ${{ steps.build.outputs.image_sha256 }}"
            fi
          else
            echo ""
            echo "âŒ Build failed"
            echo ""
            echo "Please check the build logs above for error details."
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "::endgroup::"

      - name: ðŸ“¤ Upload kernel artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.model }}-kernel
          path: ${{ matrix.model }}/artifacts/${{ steps.build.outputs.zip_name }}
          retention-days: ${{ inputs.make_release && 90 || 30 }}
          compression-level: 6
          if-no-files-found: error

      - name: ðŸ“ Job summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ### ${{ matrix.model }} - ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }}
          
          EOF
          
          if [ "${{ steps.build.outcome }}" = "success" ]; then
            BUILD_TIME="${{ steps.build.outputs.build_time }}"
            if [ -n "$BUILD_TIME" ] && [ "$BUILD_TIME" != "0" ]; then
              BUILD_MIN=$((BUILD_TIME / 60))
              BUILD_SEC=$((BUILD_TIME % 60))
              BUILD_TIME_DISPLAY="${BUILD_MIN}m ${BUILD_SEC}s"
            else
              BUILD_TIME_DISPLAY="N/A"
            fi
            
            ZIP_SIZE="${{ steps.build.outputs.zip_size }}"
            if [ -n "$ZIP_SIZE" ]; then
              ZIP_SIZE_MB=$(echo "scale=2; $ZIP_SIZE / 1024 / 1024" | bc)
              ZIP_SIZE_DISPLAY="${ZIP_SIZE_MB} MB"
            else
              ZIP_SIZE_DISPLAY="N/A"
            fi
            
            cat >> $GITHUB_STEP_SUMMARY << EOF
          | Metric | Value |
          |--------|-------|
          | **Kernel** | ${{ steps.build.outputs.kernel_version }} |
          | **SukiSU** | v${{ steps.build.outputs.sukisu_version }} |
          | **SUSFS** | ${{ steps.build.outputs.susfs_version }} |
          | **Build Time** | ${BUILD_TIME_DISPLAY} |
          | **ZIP Size** | ${ZIP_SIZE_DISPLAY} |
          EOF
            
            if [ -n "${{ steps.build.outputs.ccache_hit_rate }}" ]; then
              echo "| **ccache Hit Rate** | ${{ steps.build.outputs.ccache_hit_rate }}% âš¡ |" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -n "${{ steps.build.outputs.warnings_count }}" ]; then
              WARNINGS="${{ steps.build.outputs.warnings_count }}"
              if [ "$WARNINGS" -gt 100 ]; then
                echo "| **Warnings** | $WARNINGS âš ï¸ |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| **Warnings** | $WARNINGS |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            cat >> $GITHUB_STEP_SUMMARY << EOF
          
          **Artifact:** \`${{ steps.build.outputs.zip_name }}\`  
          **SHA256:** \`${{ steps.build.outputs.zip_sha256 }}\`
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          
          âŒ Build failed. Check the logs for details.
          EOF
          fi

      - name: ðŸ§¹ Cleanup on failure
        if: failure()
        run: |
          echo "::group::Cleanup failed build"
          
          # Remove partial artifacts
          rm -rf "${{ matrix.model }}/artifacts" || true
          rm -rf "${{ matrix.model }}/kernel_platform" || true
          
          # Show disk usage
          echo "Disk usage after cleanup:"
          df -h /
          
          echo "::endgroup::"

  # ðŸ“Š Build Summary Job
  summary:
    if: always()
    needs: [setup, build]
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š Generate Final Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ---
          
          ## ðŸ“Š Build Summary
          
          **Total Devices:** ${{ needs.setup.outputs.device_count }}  
          **Strategy:** \`${{ inputs.cache_strategy }}\`  
          **Parallel Jobs:** ${{ needs.setup.outputs.max_parallel }}
          
          ### â±ï¸ Workflow Statistics
          - **Started:** $(date -u -d @${{ github.event.workflow_run.created_at || github.event.created_at }} '+%Y-%m-%d %H:%M:%S UTC' 2>/dev/null || echo 'N/A')
          - **Duration:** Calculating...
          - **Workflow:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### ðŸŽ¯ Configuration Used
          | Setting | Value |
          |---------|-------|
          | Hook | ${{ inputs.hook }} |
          | Optimization | ${{ inputs.optimize_level }} |
          | ZRAM | ${{ inputs.enable_zram }} |
          | BBG LSM | ${{ inputs.lsm }} |
          | Fengchi | ${{ inputs.sched }} |
          
          EOF

  release:
    if: ${{ inputs.make_release && needs.build.result == 'success' }}
    needs: [setup, build]
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Generate release tag
        id: tag
        run: |
          echo "::group::Tag generation"
          
          git fetch --tags
          latest=$(git tag -l "v1.5.12-r*" | sort -V | tail -1)
          
          if [ -z "$latest" ]; then
            tag="v1.5.12-r0"
            echo "ðŸ†• Creating initial tag: $tag"
          else
            rev=$(echo $latest | grep -oP 'r\K\d+')
            tag="v1.5.12-r$((rev + 1))"
            echo "ðŸ“ˆ Incrementing from $latest to $tag"
          fi
          
          echo "TAG=$tag" >> $GITHUB_ENV
          echo "tag=$tag" >> $GITHUB_OUTPUT
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$tag" -m "Release $tag - SukiSU Ultra with SUSFS v1.5.12"
          git push origin "$tag"
          
          echo "âœ… Tag created and pushed: $tag"
          echo "::endgroup::"

      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ðŸ“¦ Prepare release assets
        id: prepare
        run: |
          echo "::group::Prepare release assets"
          
          mkdir -p release
          
          # Copy all ZIP files to release directory
          find artifacts -name "*.zip" -exec cp {} release/ \;
          
          count=$(ls -1 release/*.zip 2>/dev/null | wc -l)
          
          if [ "$count" -eq 0 ]; then
            echo "::error::No kernel ZIPs found in artifacts"
            exit 1
          fi
          
          total_size=$(du -sb release | cut -f1)
          
          echo "ðŸ“¦ Prepared $count kernel(s)"
          echo "ðŸ“Š Total size: $(numfmt --to=iec-i --suffix=B $total_size)"
          
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "total_size=$total_size" >> $GITHUB_OUTPUT
          
          # Generate release notes
          cat > notes.md << 'EOF'
          # ðŸš€ SukiSU Ultra with SUSFS v1.5.12
          
          ## ðŸ“± Built Devices
          
          EOF
          
          echo "| Device | Size | SHA256 |" >> notes.md
          echo "|--------|------|--------|" >> notes.md
          
          for zip in release/*.zip; do
            name=$(basename "$zip" .zip)
            size=$(stat -c%s "$zip")
            size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc)
            sha256=$(sha256sum "$zip" | awk '{print $1}')
            echo "| \`$name\` | ${size_mb} MB | \`${sha256:0:16}...\` |" >> notes.md
          done
          
          cat >> notes.md << 'EOF'
          
          ## âœ¨ Features
          
          - âš¡ **SukiSU Ultra Manager** - Advanced root management with enhanced features
          - ðŸ›¡ï¸ **SUSFS v1.5.12** - Enhanced security and hiding capabilities
          - ðŸ”’ **Advanced Hiding** - Hide root from banking apps, games, and security checks
          - ðŸŒ **WireGuard** - Built-in VPN support for secure connections
          - ðŸ’¾ **ZRAM** - Memory compression for better performance (optional)
          - ðŸ”§ **BBG LSM** - Baseband Guard security module (optional)
          - ðŸš€ **Optimized Build** - O2/O3 compiler optimizations for better performance
          - ðŸŽ¯ **Multiple Hook Types** - kprobe, manual, or tracepoint hooks
          
          ## ðŸ”§ Build Configuration
          
          | Setting | Value |
          |---------|-------|
          | Hook Type | `${{ inputs.hook }}` |
          | Optimization | `${{ inputs.optimize_level }}` |
          | ZRAM | ${{ inputs.enable_zram }} |
          | BBG LSM | ${{ inputs.lsm }} |
          | Fengchi Scheduler | ${{ inputs.sched }} |
          
          ## ðŸ“¥ Installation
          
          1. **Download** the ZIP file for your device
          2. **Flash** using SukiSU Manager or custom recovery (TWRP/OrangeFox)
          3. **Reboot** your device
          4. **Install** SukiSU Manager APK if not already installed
          5. **Enjoy** your rooted device with advanced features!
          
          ## âš ï¸ Important Notes
          
          - Always backup your data before flashing
          - Make sure you have the correct kernel for your device model
          - Some features may require additional modules
          - Check compatibility with your ROM version
          
          ## ðŸ”— Useful Links
          
          - [SukiSU Manager](https://github.com/SukiSU-Ultra/SukiSU-Ultra)
          - [SUSFS Module](https://github.com/sidex15/ksu_module_susfs)
          - [Installation Guide](https://github.com/SukiSU-Ultra/SukiSU-Ultra/wiki)
          - [Troubleshooting](https://github.com/SukiSU-Ultra/SukiSU-Ultra/issues)
          
          ## ðŸ“Š Build Information
          
          - **Built on:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Workflow:** ${{ github.workflow }}
          - **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Commit:** [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - **Total Devices:** ${{ needs.setup.outputs.device_count }}
          
          ## ðŸ™ Credits
          
          - **SukiSU Ultra Team** - For the amazing root solution
          - **SUSFS Developers** - For the security framework
          - **OnePlus** - For kernel sources
          - **Community Contributors** - For testing and feedback
          
          ---
          
          **Note:** This is a community build. Use at your own risk.
          EOF
          
          echo "âœ… Release notes generated"
          echo "::endgroup::"

      - name: ðŸš€ Create GitHub release
        id: release
        run: |
          echo "::group::Create GitHub release"
          
          # Create release with all assets
          gh release create "$TAG" \
            --title "ðŸŽ¯ OnePlus Kernels - SukiSU Ultra $TAG" \
            --notes-file notes.md \
            --latest \
            release/*.zip
          
          RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases/tag/$TAG"
          
          echo "âœ… Release created successfully!"
          echo "ðŸ”— URL: $RELEASE_URL"
          echo ""
          echo "ðŸ“¦ Assets uploaded: ${{ steps.prepare.outputs.count }}"
          echo "ðŸ“Š Total size: $(numfmt --to=iec-i --suffix=B ${{ steps.prepare.outputs.total_size }})"
          
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"

      - name: ðŸ“ Release summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ---
          
          ## ðŸŽ‰ Release Created Successfully
          
          **Tag:** [\`${{ steps.tag.outputs.tag }}\`](${{ steps.release.outputs.release_url }})  
          **Kernels:** ${{ steps.prepare.outputs.count }}  
          **Total Size:** $(numfmt --to=iec-i --suffix=B ${{ steps.prepare.outputs.total_size }})
          
          ### ðŸ“¦ Released Assets
          
          | Kernel | Size |
          |--------|------|
          EOF
          
          for zip in release/*.zip; do
            name=$(basename "$zip")
            size=$(stat -c%s "$zip")
            size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc)
            echo "| \`$name\` | ${size_mb} MB |" >> $GITHUB_STEP_SUMMARY
          done
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ### ðŸ”— Quick Links
          
          - [ðŸ“¥ Download Release](${{ steps.release.outputs.release_url }})
          - [ðŸ“‹ Release Notes](${{ steps.release.outputs.release_url }})
          - [ðŸ” View All Releases](${{ github.server_url }}/${{ github.repository }}/releases)
          
          ---
          
          *Thank you for using SukiSU Ultra! ðŸš€*
          EOF

      - name: ðŸ§¹ Cleanup on failure
        if: failure()
        run: |
          echo "::group::Cleanup failed release"
          
          # Delete the tag if release creation failed
          git push origin --delete "$TAG" 2>/dev/null || true
          git tag -d "$TAG" 2>/dev/null || true
          
          # Try to delete the release if it was partially created
          gh release delete "$TAG" --yes 2>/dev/null || true
          
          echo "âœ… Cleanup completed"
          echo "::endgroup::"

      - name: ðŸ“¢ Post-release actions
        if: success()
        run: |
          echo "::group::Post-release actions"
          
          echo "âœ… Release $TAG published successfully"
          echo ""
          echo "Next steps:"
          echo "  1. Verify all assets are uploaded correctly"
          echo "  2. Test download links"
          echo "  3. Update documentation if needed"
          echo "  4. Announce release to community"
          
          echo "::endgroup::"
