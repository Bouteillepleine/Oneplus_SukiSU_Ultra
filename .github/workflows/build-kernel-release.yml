name: Build OnePlus Kernels

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      make_release:
        description: 'Create release'
        type: boolean
        default: false
      op_model:
        description: 'Select kernels'
        type: choice
        options:
          - ALL
          - android15-6.6
          - android14-6.1
          - android14-5.15
          - android13-5.15
          - android13-5.10
          - android12-5.10
          - OP13-CPH
          - OP13-PJZ
          - OP13r
          - OP13S
          - OP13T
          - OP12
          - OP12r
          - OP11
          - OP11r
          - OP10pro
          - OP10t
          - OP-Nord-5
          - OP-NORD-4
          - OP-NORD-4-CE
          - OP-NORD-CE4-LITE
          - OP-ACE-5-PRO
          - OP-ACE-5
          - OP-ACE-3-PRO
          - OP-ACE-3V
          - OP-ACE-2-PRO
          - OP-ACE-2
          - OP-OPEN
          - OP-PAD-3
          - OP-PAD-2-PRO
          - OP-PAD-2
          - OP-PAD-PRO
        default: ALL
      hook:
        description: 'Hook type'
        type: choice
        options: [kprobe, manual, tracepoint]
        default: manual
      lsm:
        description: 'BBG LSM'
        type: boolean
        default: false
      sched:
        description: 'Fengchi scheduler'
        type: boolean
        default: false
      enable_zram:
        description: 'ZRAM'
        type: boolean
        default: false
      optimize_level:
        description: 'Optimization'
        type: choice
        options: [O2, O3]
        default: O2
      clean_build:
        description: 'Clean build'
        type: boolean
        default: false

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.result }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: configs/

      - id: matrix
        run: |
          [ ! -d configs ] && { echo "::error::configs/ not found"; exit 1; }
          
          echo "[" > matrix.json
          first=true
          for f in configs/*.json; do
            jq empty "$f" 2>/dev/null || continue
            [ "$first" = false ] && echo "," >> matrix.json
            jq -c '.' "$f" >> matrix.json
            first=false
          done
          echo "]" >> matrix.json
          
          input="${{ inputs.op_model }}"
          if [[ "$input" == "ALL" ]]; then
            filter="."
          elif [[ "$input" == android*-* ]]; then
            av="${input%-*}"
            kv="${input#*-}"
            filter="map(select(.android_version==\"$av\" and .kernel_version==\"$kv\"))"
          else
            filter="map(select(.model==\"$input\"))"
          fi
          
          result=$(jq -c "$filter" matrix.json)
          [ "$(jq 'length' <<<"$result")" -eq 0 ] && { echo "::error::No match"; exit 1; }
          
          echo "result=$(jq -cn --argjson i "$result" '{include:$i}')" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.setup.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - id: build
        uses: ./.github/actions
        with:
          op_config_json: ${{ toJSON(matrix) }}
          ksu_meta: 'susfs-main/âš¡Ultraâš¡/'
          hook: ${{ inputs.hook }}
          lsm: ${{ inputs.lsm }}
          enable_zram: ${{ inputs.enable_zram }}
          sched: ${{ inputs.sched }}
          optimize_level: ${{ inputs.optimize_level }}
          clean: ${{ inputs.clean_build }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.model }}-kernel
          path: ${{ matrix.model }}/artifacts/${{ steps.build.outputs.zip_name }}
          retention-days: 30

  release:
    if: ${{ inputs.make_release }}
    needs: build
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate tag
        run: |
          git fetch --tags
          latest=$(git tag -l "v1.5.12-r*" | sort -V | tail -1)
          if [ -z "$latest" ]; then
            tag="v1.5.12-r0"
          else
            rev=$(echo $latest | grep -oP 'r\K\d+')
            tag="v1.5.12-r$((rev + 1))"
          fi
          echo "TAG=$tag" >> $GITHUB_ENV
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$tag" -m "Release $tag"
          git push origin "$tag"

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release
        run: |
          mkdir release
          find artifacts -name "*.zip" -exec cp {} release/ \;
          
          cat > notes.md << 'EOF'
          # SukiSU Ultra with SUSFS v1.5.12
          
          ## Built Devices
          EOF
          
          for zip in release/*.zip; do
            name=$(basename "$zip" .zip)
            echo "- \`$name\`" >> notes.md
          done
          
          cat >> notes.md << 'EOF'
          
          ## Features
          - âš¡ SukiSU Ultra Manager
          - ðŸ›¡ï¸ SUSFS v1.5.12
          - ðŸŒ WireGuard
          - ðŸ’¾ ZRAM (optional)
          - ðŸ”§ BBG LSM (optional)
          
          ## Installation
          1. Download ZIP for your device
          2. Flash with SukiSU Manager
          3. Reboot
          
          ## Links
          - [SUSFS Module](https://github.com/sidex15/ksu_module_susfs)
          - [SukiSU Manager](https://github.com/SukiSU-Ultra/SukiSU-Ultra)
          EOF

      - name: Create release
        run: |
          gh release create "$TAG" \
            --title "OnePlus Kernels - SukiSU Ultra" \
            --notes-file notes.md \
            --prerelease \
            release/*.zip

      - if: failure()
        run: |
          git push origin --delete "$TAG" 2>/dev/null || true
          git tag -d "$TAG" 2>/dev/null || true
